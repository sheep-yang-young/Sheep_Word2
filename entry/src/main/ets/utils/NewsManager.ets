import { http } from '@kit.NetworkKit';
import { NewsItem } from '../model/NewsModel';

// å®šä¹‰æœåŠ¡å™¨è¿”å›çš„ JSON ç»“æ„
interface ServerNewsItem {
  id: string;
  title: string;
  description: string;
  content?: string;
  source?: string;
  picUrl?: string;
  date: string;
  url: string;
}

interface ServerResponse {
  date: string;
  news: ServerNewsItem[];
}

export class NewsManager {
  // ä½ çš„çœŸå®æœåŠ¡å™¨ IP
  private static readonly API_URL = 'http://8.134.10.55:3000/api/news/today';

  static async getDailyNews(): Promise<NewsItem[]> {
    const httpRequest = http.createHttp();

    try {
      // [æ ¸å¿ƒä¿®å¤] æ·»åŠ æ—¶é—´æˆ³ ?t=...
      // å°±åƒç»™å¿«é€’å•å·åŠ äº†å”¯ä¸€çš„ç§’æ•°ï¼Œè®©ç³»ç»Ÿè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå…¨æ–°çš„è¯·æ±‚ï¼Œç»å¯¹ä¸è¯»ç¼“å­˜
      const timestamp = new Date().getTime();
      const finalUrl = `${NewsManager.API_URL}?t=${timestamp}`;

      console.info(`[NewsManager] Requesting fresh data: ${finalUrl}`);

      const response = await httpRequest.request(finalUrl, {
        method: http.RequestMethod.GET,
        readTimeout: 10000,
        connectTimeout: 10000,
        expectDataType: http.HttpDataType.STRING
      });

      if (response.responseCode === 200) {
        const result = JSON.parse(response.result as string) as ServerResponse;
        const serverNews: ServerNewsItem[] = result.news;

        console.info(`[NewsManager] Fetched ${serverNews.length} items from server`);

        const mappedNews: NewsItem[] = serverNews.map((item: ServerNewsItem): NewsItem => {
          return {
            id: item.id || Math.random().toString(),
            title: item.title ? item.title.trim() : "æ— æ ‡é¢˜",
            description: item.description ? item.description.trim() : "æš‚æ— æè¿°",

            // ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€æ ¸å¿ƒä¿®å¤ã€‘ğŸ‘‡ğŸ‘‡ğŸ‘‡
            // å¦‚æœæœåŠ¡å™¨æ²¡è¿”å› contentï¼Œå°±ç”¨ description å…œåº•ï¼Œé˜²æ­¢ç™½å±
            content: item.content || item.description || "<p>æš‚æ— æ­£æ–‡å†…å®¹</p>",

            source: item.source || 'CGTN',
            picUrl: item.picUrl || "",
            date: item.date,
            url: item.url
          } as NewsItem;
        });

        return mappedNews;
      } else {
        console.error(`[NewsManager] HTTP Error: ${response.responseCode}`);
      }
    } catch (e) {
      console.error(`[NewsManager] Request Failed: ${JSON.stringify(e)}`);
    } finally {
      httpRequest.destroy();
    }
    return [];
  }
}