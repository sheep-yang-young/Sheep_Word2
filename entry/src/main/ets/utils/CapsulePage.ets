import { FloatingCapsuleManager, CapsuleRecognitionResult, CapsuleWordCandidate } from '../utils/FloatingCapsuleManager';
import { DatabaseManager } from './DatabaseManager';

type CapsuleCandidateItem = CapsuleWordCandidate & { selected?: boolean };

@Entry
@Component
struct CapsulePage {
  @State isBusy: boolean = false;
  @State showDialog: boolean = false;
  @State candidates: CapsuleCandidateItem[] = [];
  @State untranslated: string[] = [];
  @State targetBook: string = '';
  @State availableBooks: string[] = [];
  @State importSummary: string = '';

  aboutToAppear() {
    FloatingCapsuleManager.getInstance().setRecognitionListener((payload: CapsuleRecognitionResult) => {
      this.candidates = payload.words.map(item => ({ ...item, selected: true } as CapsuleCandidateItem));
      this.untranslated = payload.untranslated;
      this.targetBook = payload.suggestedBook || this.targetBook;
      this.showDialog = true;
      this.loadBooks();
      this.importSummary = '';
    });
  }

  private async loadBooks() {
    const books = await DatabaseManager.getInstance().listAllBooks();
    this.availableBooks = books;
    if (!this.targetBook || !this.availableBooks.includes(this.targetBook)) {
      this.targetBook = this.availableBooks[0] || '';
    }
  }

  build() {
    Stack() {
      Column() {
        Row() {
          if (this.isBusy) {
            LoadingProgress()
              .width(18)
              .height(18)
              .color('#FFFFFF')
              .margin({ right: 6 })
          } else {
            Text('ğŸ“·')
              .fontSize(16)
              .margin({ right: 6 })
          }

          Text(this.isBusy ? 'è¯†åˆ«ä¸­' : 'æˆªå±')
            .fontSize(14)
            .fontColor('#FFFFFF')
            .fontWeight(FontWeight.Bold)
        }
        .width('100%')
        .height('80%')
        .backgroundColor('#34495E')
        .borderRadius(25)
        .shadow({ radius: 8, color: 'rgba(0,0,0,0.4)', offsetY: 4 })
        .justifyContent(FlexAlign.Center)
        .alignItems(VerticalAlign.Center)
        .onClick(async () => {
          if (this.isBusy) return;

          this.isBusy = true;
          const count = await FloatingCapsuleManager.getInstance().triggerImageImport();
          this.isBusy = false;
          console.info(`å·²è¯†åˆ« ${count} ä¸ªå€™é€‰å•è¯`);
        })

        if (this.importSummary && !this.showDialog) {
          Text(this.importSummary)
            .fontSize(10)
            .fontColor('#F3F4F6')
            .margin({ top: 4 })
        }
      }
      .width('100%')
      .height('100%')

      if (this.showDialog) {
        this.renderSelectionDialog();
      }
    }
    .width('100%')
    .height('100%')
  }

  private renderSelectionDialog() {
    Column() {
      Text('è¯†åˆ«ç»“æœ')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 8 });

      Text(`æœªå¸¦é‡Šä¹‰ï¼š${this.untranslated.join(', ') || 'æ— '}`)
        .fontSize(12)
        .fontColor('#DC2626')
        .margin({ bottom: 6 });

      List() {
        ForEach(this.candidates, (item: any, index: number) => {
          ListItem() {
            Row() {
              Checkbox({ name: `word-${index}`, group: 'capsule-select' })
                .select(item.selected)
                .onChange((_, isChecked) => this.toggleSelection(index, isChecked));
              Column() {
                Text(item.spelling).fontWeight(FontWeight.Bold);
                Text(item.meaning || 'æš‚æ— é‡Šä¹‰').fontColor(item.hasMeaning ? '#111827' : '#DC2626').fontSize(12);
              }.margin({ left: 8 });
            }
            .padding({ top: 6, bottom: 6 });
          }
        }, (_, index: number) => `candidate-${index}`)
      }
      .height(160)
      .margin({ bottom: 8 })
      .divider({ strokeWidth: 0 });

      Row() {
        Text('å¯¼å…¥åˆ°è¯ä¹¦ï¼š').fontSize(13);
        TextInput({ text: this.targetBook, placeholder: 'è¾“å…¥æˆ–é€‰æ‹©è¯ä¹¦' })
          .width(160)
          .onChange((value: string) => { this.targetBook = value; });
      }
      .margin({ bottom: 4 })
      .alignItems(VerticalAlign.Center);

      Text(`å¯ç”¨è¯ä¹¦ï¼š${this.availableBooks.join(', ')}`)
        .fontSize(11)
        .fontColor('#6B7280')
        .margin({ bottom: 8 });

      Row() {
        Button('å–æ¶ˆ').type(ButtonType.Normal).onClick(() => { this.showDialog = false; });
        Button('ç¡®è®¤å¯¼å…¥')
          .type(ButtonType.Capsule)
          .backgroundColor('#10B981')
          .fontColor('#FFFFFF')
          .onClick(() => this.importSelected());
      }
      .justifyContent(FlexAlign.SpaceBetween)
      .width('100%')
      .margin({ bottom: 6 });

      if (this.importSummary) {
        Text(this.importSummary).fontSize(12).fontColor('#111827');
      }
    }
    .padding(12)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .shadow({ radius: 10, color: 'rgba(0,0,0,0.15)' })
    .width('100%')
    .margin({ top: 12 })
  }

  private toggleSelection(index: number, checked: boolean) {
    const updated = this.candidates.slice();
    const item = updated[index] as any;
    updated[index] = { ...item, selected: checked } as any;
    this.candidates = updated;
  }

  private async importSelected() {
    const chosen = (this.candidates as any[]).filter(item => item.selected);
    if (chosen.length === 0) {
      this.importSummary = 'è¯·å…ˆé€‰æ‹©è¦å¯¼å…¥çš„å•è¯';
      return;
    }
    const normalizedBook = this.targetBook.trim();
    if (!normalizedBook) {
      this.importSummary = 'è¯·å…ˆè¾“å…¥æˆ–é€‰æ‹©è¯ä¹¦åç§°';
      return;
    }
    const result = await FloatingCapsuleManager.getInstance().confirmImport(normalizedBook, chosen as CapsuleWordCandidate[]);
    this.importSummary = `å¯¼å…¥å®Œæˆï¼š${result.added}/${chosen.length}ï¼Œæœªé‡Šä¹‰ï¼š${result.untranslated.join(', ') || 'æ— '}`;
    this.showDialog = false;
  }
}