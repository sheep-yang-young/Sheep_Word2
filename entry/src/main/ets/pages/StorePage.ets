import { CloudBook, CloudBookManager } from '../utils/CloudBookManager';
import { WordImporter } from '../utils/WordImporter';
import { PreferenceManager } from '../utils/PreferenceManager';
import { common } from '@kit.AbilityKit';
import { promptAction } from '@kit.ArkUI';

@Component
export struct StorePage {
  @Consume('pageStack') pageStack: NavPathStack;
  @Consume refreshFlag: number;

  @State books: CloudBook[] = [];
  @State isLoading: boolean = true;
  @State isCodeMode: boolean = false;

  async aboutToAppear() {
    this.isCodeMode = await PreferenceManager.getInstance().isProgrammingMode();
    this.loadBooks();
  }

  async loadBooks() {
    this.isLoading = true;
    const allBooks = await CloudBookManager.getManifest();

    // ðŸŽ¯ æ ¸å¿ƒé€»è¾‘ï¼šæ ¹æ®å½“å‰æ¨¡å¼è¿‡æ»¤ä¹¦å•
    const targetCategory = this.isCodeMode ? 'Code' : 'English';
    this.books = allBooks.filter(b => b.category === targetCategory);

    this.isLoading = false;
  }

  async downloadAndImport(book: CloudBook) {
    try {
      promptAction.showToast({ message: `æ­£åœ¨ä¸‹è½½ ${book.name}...` });

      const context = getContext(this) as common.UIAbilityContext;
      // 1. ä¸‹è½½
      const filePath = await CloudBookManager.downloadBook(book.category, book.id, context);

      if (filePath) {
        promptAction.showToast({ message: 'ä¸‹è½½å®Œæˆï¼Œæ­£åœ¨å¯¼å…¥æ•°æ®åº“...' });

        // 2. å¯¼å…¥ (çŽ°åœ¨ WordImporter å·²ç»ä¿®å¤äº†)
        const count = await WordImporter.importJsonFileFromPath(context, filePath, book.name);

        if (count > 0) {
          // 3. è‡ªåŠ¨åˆ‡æ¢åˆ°è¿™æœ¬ä¹¦
          const pref = PreferenceManager.getInstance();
          await pref.registerBookCategory(book.name, book.category);
          const isCodeMode = await pref.setCurrentBook(book.name);
          this.refreshFlag++; // åˆ·æ–°é¦–é¡µ
          promptAction.showDialog({
            title: 'å¯¼å…¥æˆåŠŸ',
            message: `å·²å¯¼å…¥ ${count} æ¡æ•°æ®åˆ°ã€Š${book.name}ã€‹ï¼Œå¹¶å·²è®¾ä¸ºå½“å‰è¯ä¹¦ã€‚${isCodeMode ? '\nç¼–ç¨‹æ¨¡å¼å·²åŒæ­¥å¼€å¯ã€‚' : ''}`,
            buttons: [{ text: 'åŽ»èƒŒè¯µ', color: '#0A59F7' }]
          }).then(() => {
            this.pageStack.pop(); // è¿”å›žä¸Šä¸€é¡µ
          });
        }
      } else {
        promptAction.showToast({ message: 'ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—' });
      }
    } catch (e) {
      console.error('Import failed', e);
      promptAction.showToast({ message: 'å¯¼å…¥å‡ºé”™' });
    }
  }

  build() {
    NavDestination() {
      Column() {
        // æ ‡é¢˜æ 
        Row() {
          Image($r('sys.media.ohos_ic_public_arrow_left')).width(24).height(24).fillColor('#1A1A1A').onClick(() => this.pageStack.pop())
          Blank()
          Text(this.isCodeMode ? 'Dev Store (äº‘ç«¯ä»“åº“)' : 'Cloud Library (äº‘ç«¯ä¹¦åº“)')
            .fontSize(18).fontWeight(FontWeight.Bold)
            .fontFamily(this.isCodeMode ? 'Monospace' : '')
          Blank().width(24)
        }.width('100%').padding(20)

        if (this.isLoading) {
          LoadingProgress().width(50).height(50).color('#0A59F7').margin({ top: 100 })
        } else if (this.books.length === 0) {
          Column({ space: 10 }) {
            // ä½¿ç”¨é€šç”¨çš„é”™è¯¯/è­¦å‘Šå›¾æ ‡
            Image($r('sys.media.ohos_ic_public_fail')).width(60).height(60).fillColor('#CCC')
            Text('æš‚æ— ç›¸å…³ä¹¦ç±').fontColor('#999')
            Button('åˆ·æ–°').onClick(() => this.loadBooks()).height(30).backgroundColor('#F0F2F5').fontColor('#333')
          }.margin({ top: 100 })
        } else {
          List({ space: 12 }) {
            ForEach(this.books, (book: CloudBook) => {
              ListItem() {
                Row() {
                  // [ä¿®å¤] ä½¿ç”¨å­˜åœ¨çš„ç³»ç»Ÿå›¾æ ‡
                  Image(book.category === 'Code' ? $r('sys.media.ohos_ic_public_paste') : $r('sys.media.ohos_ic_public_paste'))
                    .width(40).height(40)
                    .fillColor(this.isCodeMode ? '#0A59F7' : '#FFB02E')
                    .padding(8)
                    .backgroundColor(this.isCodeMode ? '#E8F1FF' : '#FFF7E6')
                    .borderRadius(12)

                  Column({ space: 4 }) {
                    Text(book.name)
                      .fontSize(16).fontWeight(FontWeight.Medium)
                      .fontColor('#1A1A1A')
                      .fontFamily(this.isCodeMode ? 'Monospace' : '')
                    Text(book.desc)
                      .fontSize(12).fontColor('#999').maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
                  }.alignItems(HorizontalAlign.Start).layoutWeight(1).margin({ left: 12 })

                  Button('GET')
                    .height(28)
                    .fontSize(12)
                    .backgroundColor(this.isCodeMode ? '#1E1E1E' : '#0A59F7')
                    .onClick(() => this.downloadAndImport(book))
                }
                .width('100%').padding(16).backgroundColor(Color.White).borderRadius(16)
              }
            })
          }.layoutWeight(1).padding({ left: 20, right: 20 })
        }
      }
      .width('100%').height('100%').backgroundColor('#F5F7FA')
    }.hideTitleBar(true)
  }
}